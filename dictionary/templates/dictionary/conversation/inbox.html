{% extends "dictionary/base.html" %}
{% block bodyattr %}class="default topic-entry-view"{% endblock %}
{% block title %}mesajlar{% endblock %}
{% block content %}
    {% load humanize %}
    <h4><strong><a href="{% url 'messages' %}">mesajlar</a></strong> {% if unread_messages_count %}(<span>{{ unread_messages_count }} okunmamış</span>){% endif %}
        {% if request.GET.search_term %}[arama terimi: <strong>{{ request.GET.search_term }}</strong>]{% endif %}</h4>
    <hr>

    {% if conversations %}

        <ul class="threads">
            {% for chat in conversations %}
                <li {% if chat.last_message.recipient == request.user and not chat.last_message.read_at %}class="unread"{% endif %}>
                    {% with sender=chat.last_message.sender recipient=chat.last_message.recipient %}
                        {% if sender == request.user %}
                            <a href="{% url 'conversation' username=recipient.username %}">
                            <h5>{{ recipient.username }}</h5>

                        {% else %}
                            <a href="{% url 'conversation' username=sender.username %}">
                            <h5>{{ sender.username }}</h5>
                        {% endif %}
                    {% endwith %}
                    <p>{{ chat.last_message.body }}</p>
                    {{ chat.last_message.sent_at|naturaltime }}
                    </a>
                </li>

            {% endfor %}
        </ul>

        {% include "dictionary/includes/paginaton.html" with paginator=page_obj %}
    {% else %}
        <small>yok ki</small>
    {% endif %}

{% endblock %}

{% block rightframe %}

    <form action="{% url 'messages' %}" method="get">
        <label for="messages_search_term"><h5><strong>mesajlarda ara</strong></h5></label>
        <div class="input-group">
            <input name="search_term" id="messages_search_term" type="text" class="form-control"
                   placeholder="arama terimi" value="{{ request.GET.search_term }}" required>
            <div class="input-group-append">
                <button class="btn btn-django-link" type="submit">ara</button>
            </div>
        </div>
    </form>

    <hr>

    {% load widget_tweaks %}

    <form method="post">
        <label for="recipient_name"><h5><strong>yeni mesaj</strong></h5></label>

        <div class="form-group">
            <label for="recipient_name" class="col-form-label">{{ form.recipient.label }}:</label>
            {% render_field form.recipient class="form-control author-search" id="recipient_name" %}
        </div>

        <div class="form-group">
            <label for="message_body">{{ form.body.label }}:</label>
            {% render_field form.body rows="5" class="form-control" id="message_body" %}
        </div>

        {% csrf_token %}
        <button type="submit" class="btn btn-django">yolla</button>
    </form>

{% endblock %}
